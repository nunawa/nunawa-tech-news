---
import Layout from "../layouts/Layout.astro";
import { fetchFeed } from "../lib/fetchFeed";

let uploadedAt: Date | undefined = undefined;
let articles = [];

try {
  const feed = await fetchFeed();
  uploadedAt = feed.uploadedAt;
  // 10件を取得
  articles = feed.articles.slice(0, 10);
} catch (e) {
  const error = e instanceof Error ? e.message : "Unknown error occurred";
  console.error("Failed to fetch feed:", error);
  // ビルド失敗させる
  throw e;
}

/**
 * 日付をJST表示用にフォーマット
 */
function formatDateJST(date: Date, dateOnly = false) {
  let options: Intl.DateTimeFormatOptions = {};
  if (dateOnly) {
    options = {
      year: "numeric",
      month: "long",
      day: "numeric",
      timeZone: "Asia/Tokyo",
    };
  } else {
    options = {
      month: "long",
      day: "numeric",
      hour: "numeric",
      minute: "2-digit",
      timeZone: "Asia/Tokyo",
    };
  }

  return new Intl.DateTimeFormat("ja-JP", options).format(date);
}

/**
 * URLからドメイン名を抽出
 */
function extractDomain(url: string): string {
  try {
    const urlObj = new URL(url);
    return urlObj.hostname.replace(/^www\./, "");
  } catch {
    return "";
  }
}
---

<Layout description="海外テック記事の日本語サマリを配信するニュースサイト">
  <h1 class="text-3xl font-bold mb-8 text-neutral-300">
    {
      uploadedAt
        ? formatDateJST(uploadedAt, true)
        : formatDateJST(new Date(), true)
    }
  </h1>

  {
    articles.length === 0 ? (
      <p class="text-neutral-400">記事がありません</p>
    ) : (
      <div class="space-y-6">
        {articles.map((article) => (
          <article class="bg-neutral-900 border border-neutral-800 rounded-lg p-6 hover:border-neutral-700 transition-colors">
            <h2 class="text-xl font-semibold mb-2">
              <a
                href={article.link}
                target="_blank"
                rel="noopener noreferrer"
                class="text-blue-400 hover:text-blue-300 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-neutral-900 rounded"
              >
                {article.title}
              </a>
            </h2>

            <time
              datetime={article.publishDate.toISOString()}
              class="text-sm text-neutral-500 block mb-3"
            >
              {extractDomain(article.link)}
              {extractDomain(article.link) && " · "}
              {formatDateJST(article.publishDate)}
            </time>

            <p class="text-neutral-300 leading-relaxed">{article.content}</p>

            <a
              href={article.link}
              target="_blank"
              rel="noopener noreferrer"
              class="inline-block mt-4 text-blue-400 hover:text-blue-300 text-sm transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-neutral-900 rounded"
            >
              元記事を読む &#10697;
            </a>
          </article>
        ))}
      </div>
    )
  }
</Layout>
